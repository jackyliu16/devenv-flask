{% extends "base.html" %}

{% block content %}

    <!-- subheader -->
    <section id="subheader-commerce">
        <div class="container-fluid m-5-hor">
            <div class="row">
                <div class="col-md-12">
                    <h1>
                        CheckOut
                    </h1>
                    <div class="commerce-step">
                        <a></a>
                        <a class="active">Process</a>
                        <a>Payment</a>
                        <a>Receipt</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- subheader end -->

    <section id="tab-commerce" class="no-bottom">
        <div class="container-fluid m-5-hor">
            <div class="row">
                <div class="board">
                    <div class="board-inner">
                        <ul class="nav nav-tabs">
                            <div class="liner"></div>

                            <li class="active">
                                <a>
                                    <span class="title">Process</span>
                                    <span class="round-tabs step"></span>
                                </a>
                            </li>

                            <li><a>
                                <span class="title">Payment</span>
                                <span class="round-tabs step"></span>
                            </a>
                            </li>

                            <li>
                                <span class="title">Receipt</span>
                                <span class="round-tabs step"></span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="content-commerce">
        <div class="container-fluid m-5-hor onStep" data-animation="fadeInUp" data-time="300">
            <div class="row">

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                        <tr>
                            <th><h2 class="big-heading">Choose Your Package</h2></th>
                            <th></th>
                            <th>person</th>
                            <th>start/end date</th>
                            <th>price</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><img alt="commerce" width="300px" height="200px" src= {{ product_img }}></td>
                            <td>
                                <div class="flexCont">
                                    <h3>{{ product_name }}</h3>
                                </div>
                            </td>
                            <td>
                                {# TODO: check if margin correct #}
                                {#                                <button onclick="decrease()">-</button>#}
                                <input id="person-num" type="number" value='1' min="1" style="width:80px;">
                                {#                                <button onclick="increase()">+</button>#}
                            </td>
                            <td>
                                <input type="date" id="start-date"><br>
                                <input type="date" id="end-date">
                            </td>
                            {# TODO: BUG: there is possibility that the value will only display when we change it #}
                            <td>
                                <div id="price" class="big-heading"></div>
                                <div id="discount" class="disc"></div>
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>

        </div>
        </div>
    </section>

    <section>
        <div class="container-fluid m-5-hor onStep" data-animation="fadeInUp" data-time="300">
            <div class="row">
                <form action="#" method="post" name="buy-form">
                    <input type='hidden' name='unit' id="unit-collector" value="1">
                    <input type='hidden' name='price' id="price-collector">
                    <input type='hidden' name='start-time' id="start-time-collector">
                    <input type='hidden' name='end-time' id="end-time-collector">
                    <input type='hidden' name='order-time' id="order-time-collector">
                    <div class="col-md-6">
                        <h5 class="big-heading">REGISTER NOW</h5>
                        <hr>
                        <div class="form-group row">
                            <div class="col-xs-6">
                                <input name="firstname" type="text" class="form-control" required="" id="firstname"
                                       placeholder="First Name*" value={{ current_user.firstname }}>
                            </div>
                            <div class="col-xs-6">
                                <input name="lastname" type="text" class="form-control" required="" id="lastname"
                                       placeholder="last Name*" value={{ current_user.lastname }}>
                            </div>
                        </div>
                        <div class="form-group">
                            <input name="companyname" type="text" class="form-control" required="" id="companyname"
                                   placeholder="Company Name*">
                        </div>
                        <div class="form-group row">
                            <div class="col-xs-5">
                                <input name="zipcode" type="text" class="form-control" required="" id="zipcode"
                                       placeholder="Zip Code*">
                            </div>
                            <div class="col-xs-7">
                                <input name="city" type="text" class="form-control" required="" id="city"
                                       placeholder="City*">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-xs-6">
                                <input name="email" type="text" class="form-control" required="" id="emailcom"
                                       placeholder="Email*">
                            </div>
                            <div class="col-xs-6">
                                <input name="phone" type="text" class="form-control" required="" id="phonecom"
                                       placeholder="Phone*">
                            </div>
                        </div>
                        <br/>
                        <div class="checkbox">
                            <label><input name="read" type="checkbox" required=""> I have read and accepted our terms of
                                bussiness
                                condition</label>
                        </div>
                        <br/>
                        <div class="checkbox">
                            <label><input type="checkbox"> Subscribe our Newsletter</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="big-heading">CHOOSE PROCESSED</h5>
                        <hr>
                        <h5>Standard Tour</h5>
                        <div class="checkbox">
                            <label><input type="checkbox" name="travelType" class="travel-option">This is the most basic
                                level of tourism, with relatively low
                                prices, suitable for travelers with limited budgets. Standard tourism typically includes
                                budget hotels, basic transportation, and standard tour items.</label>
                        </div>
                        <h5>Premium Tour</h5>
                        <div class="checkbox">
                            <label><input type="checkbox" name="travelType" class="travel-option"> This is a moderate
                                level of tourism with relatively high
                                prices, providing better services and facilities. Premium tourism usually includes
                                high-end hotels, Private transport and more tourism options.</label>
                        </div>
                        <h5>Luxury Tour</h5>
                        <div class="checkbox">
                            <label><input type="checkbox" name="travelType" class="travel-option"> This is the highest
                                level of tourism, with the highest price,
                                providing travelers with the highest level of service and experience. Luxury tourism
                                typically includes luxury hotels, private luxury transportation, and unique unique
                                experiences, such as private tour guides, private yachts, and tasting top-notch cuisine.</label>
                        </div>
                        <p>Learn more from our an expert team.</p>
                    </div>
                    <div class="clearfix"></div>
                    <div class="col-md-6">
                        <button type="submit" style="width:200%" id="send-ecom" class="btn-ecom"
                                href="/ecommerce-payment">Go to Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
{% endblock %}

{% block script %}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function () {
            init_collector();

            selectedPerson = 1;
            var price = {{ detail_dic['price'] | int}};
            $('#person-num, #start-date, #end-date').change(function () {
                var calculatedPrice = 0
                var discount = 0
                var selectedPerson = parseInt($('#person-num').val());
                var startDateStr = $('#start-date').val();
                var endDateStr = $('#end-date').val();
                var startDate = new Date(startDateStr);
                var endDate = new Date(endDateStr);
                // TODO: when endDate early than startDate, it should have a alert or other
                var dateDifference = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
                    var calculatedPrice = selectedPerson * price * dateDifference * 0.8;  // 根据选择的人数计算价格
                    console.log("diff" + selectedPerson + " " + price + " " + dateDifference);
                    var discount = calculatedPrice * 1.25;  // 根据选择的人数计算折扣


                    $('#price').text('$ ' + calculatedPrice);
                    $("#price-collector").val(calculatedPrice);
                    $('#discount').text('$ ' + discount);

                    // update collector
                    $("#unit-collector").val(selectedPerson);
                    $("#start-time-collector").val(startDateStr);
                    $("#end-time-collector").val(endDateStr);
                });

                function init_collector() {
                    // 获取当前日期
                    var currentDate = new Date();
                    
                    // 格式化日期为 YYYY-MM-DD
                    var formattedDate = currentDate.toISOString().split('T')[0];
                    
                    // current time is default time
                    $('#start-date').val(formattedDate);
                    $('#end-date').val(formattedDate);
                    $('#price').val(0); // TODO: BUG: it seems not working.

                    $("#unit-collector").val(document.getElementById('persom-num'));
                    $("#start-time-collector").val(formattedDate);
                    $("#end-time-collector").val(formattedDate);
                    $("#order-time-collector").val(formattedDate);
                }
            });
    </script>
    <script>
        // BUG: when using this two script will not calling the calculatedPrice recalculated.
        function decrease() {
            var input = document.getElementById("person-num");
            var value = parseInt(input.value);
            
            if (!isNaN(value) && (value > 1)) {
                value--;
                input.value = value;
            }
        }

        function increase() {
            var input = document.getElementById("person-num");
            var value = parseInt(input.value);
            
            if (!isNaN(value) && (value < 99)) {
                value++;
                input.value = value;
            }
        }
  </script>
  <!--<script>
    document.getElementById('your-form-id').addEventListener('submit', function(event) {
        // 阻止默认的表单提交行为
        event.preventDefault();

        // 获取特定 ID 字段的值
        var specialFieldValue = document.getElementById('special-field').value;

        // 创建一个新的表单元素
        var newInputElement = document.createElement('input');
        newInputElement.type = 'hidden'; // 设置新元素的类型为隐藏元素
        newInputElement.name = 'new-field'; // 设置新元素的名称
        newInputElement.value = specialFieldValue; // 将特定字段的值赋给新元素的值

        // 将新的表单元素添加到表单中
        var form = document.getElementById('your-form-id');
        form.appendChild(newInputElement);

        // 提交表单
        form.submit();
    });
  </script>-->
    <script>
        const checkboxes = document.querySelectorAll('.travel-option');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                checkboxes.forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                    }
                });
            });
        });
    </script>
{% endblock %}